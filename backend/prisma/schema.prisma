// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  previewFeatures = []
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum PersistMode {
  raw
  interval
}

enum PersistAggregate {
  sum
  avg
  min
  max
  last
}

model Tenant {
  id        String   @id @default(uuid()) @db.Uuid
  slug      String   @unique
  name      String
  iconUrl   String?  @map("icon_url")
  aiConfig  Json?    @map("ai_config") @db.JsonB
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz

  plants          Plant[]
  gateways        Gateway[]
  plcs            Plc[]
  telemetryEvents TelemetryEvent[]
  plcStates       PlcState[]
  alarms          Alarm[]
  persistRules    PersistRule[]
  telemetryAggregated TelemetryAggregated[]
  plcDashboards   PlcDashboard[]
  metricCatalog   MetricCatalog[]
  aiInsights      AIInsight[]
  companyOverviewAccess TenantCompanyOverviewAccess[]

  @@map("tenants")
}

model Plant {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @map("tenant_id") @db.Uuid
  province  String
  plantId   String   @map("plant_id")
  name      String?
  aiConfig  Json?    @map("ai_config") @db.JsonB
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz

  tenant          Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  plcs            Plc[]
  gateways        Gateway[]
  telemetryEvents TelemetryEvent[]
  telemetryAggregated TelemetryAggregated[]
  plcStates       PlcState[]
  alarms          Alarm[]
  plcDashboards   PlcDashboard[]
  persistRules    PersistRule[]
  aiInsights      AIInsight[]
  metricCatalog   MetricCatalog[]

  @@unique([tenantId, province, plantId])
  @@index([tenantId, province])
  @@map("plants")
}

model Gateway {
  id         String   @id @default(uuid()) @db.Uuid
  tenantId   String   @map("tenant_id") @db.Uuid
  plantId    String   @map("plant_id") @db.Uuid
  gatewayId  String   @map("gateway_id")
  state      String   @default("offline")
  version    String?
  uptimeSec  Int?     @map("uptime_sec")
  lastSeenAt DateTime? @map("last_seen_at") @db.Timestamptz
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt  DateTime @updatedAt @map("updated_at") @db.Timestamptz

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  plant  Plant  @relation(fields: [plantId], references: [id], onDelete: Cascade)
  plcs            Plc[]
  persistRules    PersistRule[]
  telemetryEvents TelemetryEvent[]
  telemetryAggregated TelemetryAggregated[]

  @@unique([tenantId, gatewayId])
  @@index([tenantId, plantId])
  @@map("gateways")
}

model Plc {
  id         String   @id @default(uuid()) @db.Uuid
  tenantId   String   @map("tenant_id") @db.Uuid
  plantId    String   @map("plant_id") @db.Uuid
  gatewayId  String   @map("gateway_id") @db.Uuid
  plcThingName String @map("plc_thing_name")
  name       String?
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  plant  Plant  @relation(fields: [plantId], references: [id], onDelete: Cascade)
  gateway Gateway @relation(fields: [gatewayId], references: [id], onDelete: Cascade)

  telemetryEvents TelemetryEvent[]
  telemetryAggregated TelemetryAggregated[]
  state           PlcState?
  alarms          Alarm[]
  dashboards      PlcDashboard[]
  persistRules    PersistRule[]
  metricCatalog   MetricCatalog[]

  @@unique([tenantId, plantId, plcThingName])
  @@index([tenantId, plantId])
  @@index([tenantId, plantId, gatewayId])
  @@map("plcs")
}

model GlobalConfig {
  key       String   @id
  value     String   @db.Text
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz
  updatedBy String?  @map("updated_by")

  @@map("global_config")
}

model TenantCompanyOverviewAccess {
  id         String   @id @default(uuid()) @db.Uuid
  tenantId   String   @map("tenant_id") @db.Uuid
  emailLower String   @map("email_lower")
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt  DateTime @updatedAt @map("updated_at") @db.Timestamptz
  createdBy  String?  @map("created_by")
  updatedBy  String?  @map("updated_by")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, emailLower])
  @@index([tenantId])
  @@map("tenant_company_overview_access")
}

model MetricCatalog {
  id           String   @id @default(uuid()) @db.Uuid
  tenantId     String   @map("tenant_id") @db.Uuid
  plantId      String?  @map("plant_id") @db.Uuid
  plcId        String?  @map("plc_id") @db.Uuid
  metricId     String   @map("metric_id")

  label        String
  unit         String?
  description  String?  @db.Text

  enabledForAI Boolean  @default(true) @map("enabled_for_ai")
  aiPriority   Int      @default(0) @map("ai_priority")
  keyForCEO    Boolean  @default(false) @map("key_for_ceo")
  keyForPlant  Boolean  @default(false) @map("key_for_plant")

  catalogVersion Int    @default(1) @map("catalog_version")
  updatedBy      String? @map("updated_by")
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt      DateTime @updatedAt @map("updated_at") @db.Timestamptz

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  plant  Plant? @relation(fields: [plantId], references: [id], onDelete: Cascade)
  plc    Plc?   @relation(fields: [plcId], references: [id], onDelete: Cascade)

  @@unique([tenantId, plantId, plcId, metricId])
  @@index([tenantId, metricId])
  @@index([tenantId, plantId, metricId])
  @@index([tenantId, plantId, plcId, metricId])
  @@map("metric_catalog")
}

model AIInsight {
  id              String   @id @default(uuid()) @db.Uuid
  tenantId        String   @map("tenant_id") @db.Uuid
  plantId         String?  @map("plant_id") @db.Uuid // null = company overview
  type            String   // 'plant' | 'company'
  status          String   @default("pending") // pending | running | success | error

  // Output for UI (nullable while pending/running/error)
  contentJson      Json?    @map("content_json") @db.JsonB
  contentMarkdown  String?  @map("content_markdown") @db.Text

  // Audit (nullable while pending/running)
  inputSnapshotJson Json?   @map("input_snapshot_json") @db.JsonB
  inputHash         String? @map("input_hash")
  promptVersion     String? @map("prompt_version")
  systemPromptVer   String? @map("system_prompt_ver")
  catalogVersion    Int     @default(1) @map("catalog_version")
  stale             Boolean @default(false)

  modelUsed         String? @map("model_used")
  promptTokens      Int     @default(0) @map("prompt_tokens")
  completionTokens  Int     @default(0) @map("completion_tokens")
  totalTokens       Int     @default(0) @map("total_tokens")

  periodStart       DateTime @map("period_start") @db.Timestamptz
  periodEnd         DateTime @map("period_end") @db.Timestamptz
  expiresAt         DateTime @map("expires_at") @db.Timestamptz

  errorCode         String?  @map("error_code")
  errorMessage      String?  @map("error_message") @db.Text

  generatedAt       DateTime? @map("generated_at") @db.Timestamptz
  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt         DateTime  @updatedAt @map("updated_at") @db.Timestamptz

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  plant  Plant? @relation(fields: [plantId], references: [id], onDelete: Cascade)

  @@index([tenantId, plantId, type])
  @@index([tenantId, type, generatedAt(sort: Desc)])
  @@map("ai_insights")
}

model TelemetryEvent {
  id             String   @id @default(uuid()) @db.Uuid
  tenantId       String   @map("tenant_id") @db.Uuid
  plantId        String   @map("plant_id") @db.Uuid
  gatewayId      String   @map("gateway_id") @db.Uuid
  plcId          String   @map("plc_id") @db.Uuid
  metricId       String   @map("metric_id")
  ts             DateTime @db.Timestamptz
  topic          String
  valuesJson     Json     @map("values_json") @db.JsonB
  rawJson        Json     @map("raw_json") @db.JsonB
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz

  plc     Plc    @relation(fields: [plcId], references: [id], onDelete: Cascade)
  tenant  Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  plant   Plant  @relation(fields: [plantId], references: [id], onDelete: Cascade)
  gateway Gateway @relation(fields: [gatewayId], references: [id], onDelete: Cascade)

  @@index([tenantId, plantId, ts(sort: Desc)])
  @@index([plcId, ts(sort: Desc)])
  @@unique([tenantId, plantId, gatewayId, plcId, metricId, ts])
  @@map("telemetry_events")
}

model PersistRule {
  id              String   @id @default(uuid()) @db.Uuid
  tenantId        String   @map("tenant_id") @db.Uuid
  plantId         String?  @map("plant_id") @db.Uuid
  gatewayId       String?  @map("gateway_id") @db.Uuid
  plcId           String?  @map("plc_id") @db.Uuid
  metricId        String   @map("metric_id")
  mode            PersistMode
  intervalMinutes Int?     @map("interval_minutes") // Solo para mode=interval, cada cuántos minutos agregar
  aggregate       PersistAggregate?
  retentionDays   Int      @map("retention_days") @default(7)
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime @updatedAt @map("updated_at") @db.Timestamptz

  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  plant   Plant?  @relation(fields: [plantId], references: [id], onDelete: Cascade)
  gateway Gateway? @relation(fields: [gatewayId], references: [id], onDelete: Cascade)
  plc     Plc?    @relation(fields: [plcId], references: [id], onDelete: Cascade)

  @@index([tenantId, metricId])
  @@index([tenantId, plantId, plcId, metricId])
  @@map("persist_rules")
}

model TelemetryAggregated {
  id              String   @id @default(uuid()) @db.Uuid
  tenantId        String   @map("tenant_id") @db.Uuid
  plantId         String   @map("plant_id") @db.Uuid
  gatewayId       String   @map("gateway_id") @db.Uuid
  plcId           String   @map("plc_id") @db.Uuid
  metricId        String   @map("metric_id")
  bucket          DateTime @db.Timestamptz // Inicio del intervalo (puede ser cada X minutos)
  intervalMinutes Int      @map("interval_minutes") // Duración del intervalo en minutos
  count           Int      @default(0)
  sum             Float?
  min             Float?
  max             Float?
  lastValueJson   Json?    @map("last_value_json") @db.JsonB
  lastTs          DateTime? @map("last_ts") @db.Timestamptz
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime @updatedAt @map("updated_at") @db.Timestamptz

  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  plant   Plant   @relation(fields: [plantId], references: [id], onDelete: Cascade)
  gateway Gateway @relation(fields: [gatewayId], references: [id], onDelete: Cascade)
  plc     Plc     @relation(fields: [plcId], references: [id], onDelete: Cascade)

  @@unique([tenantId, plantId, gatewayId, plcId, metricId, bucket, intervalMinutes])
  @@index([tenantId, plantId, plcId, metricId, bucket(sort: Desc)])
  @@map("telemetry_aggregated")
}

model PlcState {
  plcId          String   @id @map("plc_id") @db.Uuid
  tenantId       String   @map("tenant_id") @db.Uuid
  plantId        String   @map("plant_id") @db.Uuid
  lastTs         DateTime @map("last_ts") @db.Timestamptz
  lastValuesJson Json     @map("last_values_json") @db.JsonB
  updatedAt      DateTime @updatedAt @map("updated_at") @db.Timestamptz

  plc     Plc    @relation(fields: [plcId], references: [id], onDelete: Cascade)
  tenant  Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  plant   Plant  @relation(fields: [plantId], references: [id], onDelete: Cascade)

  @@index([tenantId, plantId])
  @@map("plc_state")
}

model Alarm {
  id           String   @id @default(uuid()) @db.Uuid
  tenantId     String   @map("tenant_id") @db.Uuid
  plantId      String   @map("plant_id") @db.Uuid
  plcId        String   @map("plc_id") @db.Uuid
  ts           DateTime @db.Timestamptz
  type         String
  message      String
  severity     String
  acknowledged Boolean  @default(false)
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz

  plc    Plc    @relation(fields: [plcId], references: [id], onDelete: Cascade)
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  plant  Plant  @relation(fields: [plantId], references: [id], onDelete: Cascade)

  @@index([tenantId, plantId, ts(sort: Desc)])
  @@index([plcId, ts(sort: Desc)])
  @@index([acknowledged, severity])
  @@map("alarms")
}

model PlcDashboard {
  id            String   @id @default(uuid()) @db.Uuid
  tenantId      String   @map("tenant_id") @db.Uuid
  plantId       String   @map("plant_id") @db.Uuid
  plcId         String   @map("plc_id") @db.Uuid
  name          String
  iconUrl       String?  @map("icon_url")
  layoutVersion Int      @default(1) @map("layout_version")
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt     DateTime @updatedAt @map("updated_at") @db.Timestamptz

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  plant  Plant  @relation(fields: [plantId], references: [id], onDelete: Cascade)
  plc    Plc    @relation(fields: [plcId], references: [id], onDelete: Cascade)
  widgets PlcDashboardWidget[]

  @@unique([tenantId, plantId, plcId])
  @@index([tenantId, plantId, plcId])
  @@map("plc_dashboards")
}

model PlcDashboardWidget {
  id              String   @id @default(uuid()) @db.Uuid
  plcDashboardId  String   @map("plc_dashboard_id") @db.Uuid
  widgetKey       String   @map("widget_key")
  type            String
  label           String
  metricId        String   @map("metric_id")
  unit            String?
  dataType        String?  @map("data_type")
  configJson      Json     @map("config_json") @db.JsonB
  layoutJson      Json     @map("layout_json") @db.JsonB
  sortOrder       Int      @default(0) @map("sort_order")
  isVisible       Boolean  @default(true) @map("is_visible")
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime @updatedAt @map("updated_at") @db.Timestamptz

  dashboard PlcDashboard @relation(fields: [plcDashboardId], references: [id], onDelete: Cascade)

  @@unique([plcDashboardId, widgetKey])
  @@index([plcDashboardId])
  @@map("plc_dashboard_widgets")
}
